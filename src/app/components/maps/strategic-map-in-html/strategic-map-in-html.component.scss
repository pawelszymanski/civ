@import '../../../../styles/mixins';
@import '../../../../styles/variables';

@function tile-width() {
  @return calc(var(--tile-size) * 0.9);
}

@function tile-height() {
  @return var(--tile-size);
}

// JS: mapWidth = tileWidth * map.width + Math.ceil(tileWidth * 0.5);
@function map-width($x) {
  $base-width: calc(#{tile-width()} * #{$x});
  $indent-width: calc(#{tile-width()} * 0.5);
  @return calc(#{$base-width} + #{$indent-width});
}

@function row-height() {
  @return calc((#{tile-height()} * 0.75) - 1px);
}

// JS: mapHeight = (tileHeight * map.height * 0.75) + Math.ceil(tileHeight * 0.25) - (map.height - 1);
@function map-height($y) {
  $base-height: calc(#{row-height()} * #{$y});
  $first-tile-quarter: calc(#{tile-height()} * 0.25);
  @return calc(#{$base-height} + #{$first-tile-quarter});
}

.strategic-map-in-html-component {
  @include position-block(absolute, 0, 0, 0, 0, $z-index-game-map);

  .overlay {
    position: absolute;
    z-index: 1;
    background: transparent;
  }

  .map {
    display: block;

    @for $x from 1 through $max-map-tiles-x {
      &.m-x-#{$x} {
        width: map-width($x);
      }
    }

    @for $y from 1 through $max-map-tiles-y {
      &.m-y-#{$y} {
        height: map-height($y);
      }
    }

    // ------------------
    // Basic tile styling
    // ------------------
    .tile {
      display: block;
      position: absolute;
      width: tile-width();
      height: tile-height();
      text-align: center;
      background-size: 180% 120%;
      clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
      margin-bottom: calc((var(--tile-size) / -4) - 1px);
      @include disable-selection;

      @for $x from 0 through ($max-map-tiles-x - 1) {
        &.m-x-#{$x} {
          left: calc(#{tile-width()} * #{$x});
          &.m-indent {
            left: calc(#{tile-width()} * (#{$x} + 0.5));
          }
        }
      }

      @for $y from 0 through ($max-map-tiles-y - 1) {
        &.m-y-#{$y} {
          top: calc(#{row-height()} * #{$y});
        }
      }

    }

    // ------------------------------------------------------------------------------------------------
    // Make terrain background flow through tiles (since `background-attachment: fixed` is not working)
    // ------------------------------------------------------------------------------------------------
    .tile {

      @for $i from 0 through ($max-map-tiles-x - 1) {
        &:nth-of-type(2n+1) {
          &.m-x-#{$i} {
            background-position-x: $i * 125%;
          }
        }
        &:nth-of-type(2n+0) {
          &.m-x-#{$i} {
            background-position-x: $i * 125% + 62.5%;
          }
        }
      }

      @for $i from 0 through ($max-map-tiles-y - 1) {
        &.m-y-#{$i} {
          background-position-y: -$i * 226%;
          z-index: $max-map-tiles-y - $i;       // Make whole hexagon area hoverable
        }
      }

    }

    // ----------------------------
    // Terrain, features, resources
    // ----------------------------
    .tile {

      &:before {
        content: '';
        display: block;
        @include position-block(absolute, 0, 0, 0, 0);
        background-size: 100%;
        background-position: center;
        background-repeat: no-repeat;
      }

      // Base terrain texture. Based on the land type.
      &[class*='m-base-grassland'] { background-image: url('/assets/game-map/terrain/textures/grassland.png'); }
      &[class*='m-base-plains']    { background-image: url('/assets/game-map/terrain/textures/plains.png'); }
      &[class*='m-base-desert']    { background-image: url('/assets/game-map/terrain/textures/desert.png'); }
      &[class*='m-base-tundra']    { background-image: url('/assets/game-map/terrain/textures/tundra.png'); }
      &[class*='m-base-snow']      { background-image: url('/assets/game-map/terrain/textures/snow.png'); }
      &.m-base-lake,
      &.m-base-coast { background-image: url('/assets/game-map/terrain/textures/coast.png'); }
      &.m-base-ocean { background-image: url('/assets/game-map/terrain/textures/ocean.png'); }

      // Hills. Example: `m-base-desert-hills-2`
      @each $land-type in $terrain-base-land-type-list {
        @for $variation from 1 through 3 {
          &.m-base-#{$land-type}-hills-#{$variation} {
            &:before { background-image: url('/assets/game-map/terrain/hills/#{$land-type}-hills-#{$variation}.webp'); }
          }
        }
      }

      // Mountains. Example: `m-base-snow-mountain-3`
      @each $land-type in $terrain-base-land-type-list {
        @for $variation from 1 through 5 {
          &.m-base-#{$land-type}-mountain-#{$variation} {
            &:before { background-image: url('/assets/game-map/terrain/mountain/mountain-#{$variation}.webp'); }
          }
        }
      }

      // Woods. Example: `m-feature-woods-1`
      @for $variation from 1 through 1 {
        &.m-feature-woods-#{$variation} {
          &:before { background-image: url('/assets/game-map/terrain/features/woods-#{$variation}.webp'); }
        }
      }

      // Rainforest. Example: `m-feature-rainforest-1`
      @for $variation from 1 through 1 {
        &.m-feature-rainforest-#{$variation} {
          &:before { background-image: url('/assets/game-map/terrain/features/rainforest-#{$variation}.webp'); }
        }
      }

      // Floodplains. Example: `m-feature-floodplains-1`
      @for $variation from 1 through 1 {
        &.m-feature-floodplains-#{$variation} {
          &:before { background-image: url('/assets/game-map/terrain/features/floodplains-#{$variation}.webp'); }
        }
      }

      // Marsh. Example: `m-feature-marsh-1`
      @for $variation from 1 through 1 {
        &.m-feature-marsh-#{$variation} {
          &:before { background-image: url('/assets/game-map/terrain/features/marsh-#{$variation}.webp'); }
        }
      }

      // Oasis. Example: `m-feature-oasis-1`
      @for $variation from 1 through 1 {
        &.m-feature-oasis-#{$variation} {
          &:before { background-image: url('/assets/game-map/terrain/features/oasis-#{$variation}.webp'); }
        }
      }

      // Reef. Example: `m-feature-reef-1`
      @for $variation from 1 through 1 {
        &.m-feature-reef-#{$variation} {
          &:before { background-image: url('/assets/game-map/terrain/features/reef-#{$variation}.webp'); }
        }
      }

      // Ice. Example: `m-feature-ice-1`
      @for $variation from 1 through 1 {
        &.m-feature-ice-#{$variation} {
          &:before { background-image: url('/assets/game-map/terrain/features/ice-#{$variation}.webp'); }
        }
      }

      // Woods ON Hills
      @each $terrain-base in $terrain-base-land-type-list {
        @for $woods-variation from 1 through 1 {
          @for $hills-variation from 1 through 3 {
            &.m-feature-woods-#{$woods-variation} {
              &.m-base-#{$terrain-base}-hills-#{$hills-variation} {
                &:before {
                  $woodsUrl: '/assets/game-map/terrain/features/woods-#{$woods-variation}.webp';
                  $hillsUrl: '/assets/game-map/terrain/hills/#{$terrain-base}-hills-#{$hills-variation}.webp';
                  background-image: url($woodsUrl), url($hillsUrl);
                }
              }
            }
          }
        }
      }

      // Rainforest ON Hills
      @each $terrain-base in $terrain-base-land-type-list {
        @for $rainforest-variation from 1 through 1 {
          @for $hills-variation from 1 through 3 {
            &.m-feature-rainforest-#{$rainforest-variation} {
              &.m-base-#{$terrain-base}-hills-#{$hills-variation} {
                &:before {
                  $woodsUrl: '/assets/game-map/terrain/features/rainforest-#{$rainforest-variation}.webp';
                  $hillsUrl: '/assets/game-map/terrain/hills/#{$terrain-base}-hills-#{$hills-variation}.webp';
                  background-image: url($woodsUrl), url($hillsUrl);
                }
              }
            }
          }
        }
      }

      // Resources. Example: `m-resource-amber`
      @each $resource in $terrain-resource-list {
        &.m-resource-#{$resource} {
          &:after {
            content: '';
            display: block;
            @include size(100%);
            @include position-block(relative, calc(var(--tile-size) * -0.1), 0, 0, 0);
            background: url('/assets/icons/terrain/resources/#{$resource}.webp') no-repeat;
            background-position-x: center;
            background-position-y: bottom;
            background-size: calc(var(--tile-size) * 0.2 + 4px);
          }
        }
      }

    }

  }
}
